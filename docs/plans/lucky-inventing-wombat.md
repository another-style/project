# Сортировка тем по последнему комментарию

## Контекст

Сейчас главная страница показывает темы (корневые комментарии), отсортированные по дате создания (`created_at`). Пользователь хочет, чтобы темы с недавними ответами поднимались наверх — как на классических форумах.

## Подход

Добавить денормализованное поле `last_comment_at` в таблицу `comments`. При создании нового ответа обновлять это поле у корневого (root) комментария темы. Сортировать главную страницу по этому полю.

Это эффективнее подзапроса — сортировка по одному индексированному столбцу.

## Изменения

### 1. Миграция: добавить столбец `last_comment_at`

**Файл**: новая миграция `database/migrations/..._add_last_comment_at_to_comments_table.php`

- Добавить `timestamp('last_comment_at')->nullable()->index()`
- В миграции заполнить для существующих корневых комментариев: для каждого root-комментария найти максимальный `created_at` среди потомков (через `_lft`/`_rgt` nested set) и записать в `last_comment_at`. Если потомков нет — использовать собственный `created_at`.

### 2. Модель Comment: обновление `last_comment_at` при создании ответа

**Файл**: `app/Models/Comment.php`

- Добавить boot-метод с событием `created`: если у нового комментария есть `parent_id`, найти корневого предка (через `ancestors()->whereNull('parent_id')->first()` или цепочку) и обновить его `last_comment_at` на `now()`.
- Для новых корневых комментариев (без `parent_id`) устанавливать `last_comment_at = created_at` тоже в событии `created`.

### 3. Контроллер: сортировка по `last_comment_at`

**Файл**: `app/Http/Controllers/CommentController.php`

- В методе `index()`: заменить `orderByDesc('created_at')` на `orderByDesc('last_comment_at')`.
- В методе `store()`: после создания комментария с `parent_id`, обновлять `last_comment_at` у root-темы. (Или полагаться на model event из п.2 — предпочтительнее.)

### 4. Фронтенд: отображение даты последнего комментария

**Файл**: `resources/js/Pages/Home.vue`

- Рядом с датой создания темы показать дату последнего комментария (если отличается от `created_at`), например: «Последний ответ: дд.мм.гггг чч:мм».

### 5. Seeder (если есть)

- Обновить seeder комментариев, чтобы он заполнял `last_comment_at` для корневых комментариев.

## Файлы для изменения

- `app/Models/Comment.php` — boot event для обновления `last_comment_at`
- `app/Http/Controllers/CommentController.php` — сортировка в `index()`
- `resources/js/Pages/Home.vue` — отображение даты последнего ответа
- Новая миграция — добавление столбца
- `database/seeders/CommentSeeder.php` (если существует) — обновление

## Проверка

1. Запустить миграцию: `docker compose exec php php artisan migrate`
2. Открыть главную страницу — темы должны быть отсортированы по дате последнего комментария
3. Добавить ответ в старую тему — она должна подняться наверх списка
4. Создать новую тему — она должна появиться наверху
5. Запустить тесты: `docker compose exec php composer test`
