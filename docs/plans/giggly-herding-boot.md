# –ü–ª–∞–Ω: –õ–∞–π–∫–∏ –∏ –¥–∏–∑–ª–∞–π–∫–∏ –¥–ª—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ (–ø–æ IP)

## –ö–æ–Ω—Ç–µ–∫—Å—Ç

–ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å–∏—Å—Ç–µ–º—É –ª–∞–π–∫–æ–≤/–¥–∏–∑–ª–∞–π–∫–æ–≤ –∫ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º. –£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –≥–æ–ª–æ—Å–∞ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø–æ IP-–∞–¥—Ä–µ—Å—É. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –ø–æ—Å—Ç–∞–≤–∏—Ç—å –ª–∞–π–∫ –∏–ª–∏ –¥–∏–∑–ª–∞–π–∫, –ø–æ–≤—Ç–æ—Ä–Ω–æ–µ –Ω–∞–∂–∞—Ç–∏–µ —Å–Ω–∏–º–∞–µ—Ç –≥–æ–ª–æ—Å. –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É –ª–∞–π–∫–æ–º –∏ –¥–∏–∑–ª–∞–π–∫–æ–º —Ç–æ–∂–µ –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å.

## 1. –ú–∏–≥—Ä–∞—Ü–∏—è ‚Äî —Ç–∞–±–ª–∏—Ü–∞ `comment_votes`

–§–∞–π–ª: `database/migrations/xxxx_create_comment_votes_table.php`

| –ü–æ–ª–µ         | –¢–∏–ø                | –û–ø–∏—Å–∞–Ω–∏–µ                          |
|--------------|--------------------|------------------------------------|
| `id`         | bigIncrements      | PK                                 |
| `comment_id` | unsignedBigInteger | FK ‚Üí comments.id, CASCADE DELETE   |
| `ip_address` | string(45)         | IP –≥–æ–ª–æ—Å—É—é—â–µ–≥–æ                     |
| `vote`       | tinyInteger        | 1 = –ª–∞–π–∫, -1 = –¥–∏–∑–ª–∞–π–∫            |
| `created_at` | timestamp          |                                    |
| `updated_at` | timestamp          |                                    |

- –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å: `(comment_id, ip_address)` ‚Äî –æ–¥–∏–Ω –≥–æ–ª–æ—Å —Å –æ–¥–Ω–æ–≥–æ IP –Ω–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π.

–¢–∞–∫–∂–µ –¥–æ–±–∞–≤–∏—Ç—å –≤ —Ç–∞–±–ª–∏—Ü—É `comments` –¥–≤–∞ –∫—ç—à–∏—Ä—É—é—â–∏—Ö –ø–æ–ª—è:
- `likes_count` int default 0
- `dislikes_count` int default 0

–≠—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç –Ω–µ —Å—á–∏—Ç–∞—Ç—å –≥–æ–ª–æ—Å–∞ —á–µ—Ä–µ–∑ JOIN/–ø–æ–¥–∑–∞–ø—Ä–æ—Å –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ.

## 2. –ú–æ–¥–µ–ª—å CommentVote

–§–∞–π–ª: `app/Models/CommentVote.php`

- –°–≤—è–∑—å `belongsTo(Comment::class)`
- `$fillable = ['comment_id', 'ip_address', 'vote']`

–í –º–æ–¥–µ–ª–∏ `Comment` –¥–æ–±–∞–≤–∏—Ç—å:
- –°–≤—è–∑—å `hasMany(CommentVote::class)`

## 3. –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä ‚Äî —ç–Ω–¥–ø–æ–∏–Ω—Ç –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è

–§–∞–π–ª: `app/Http/Controllers/CommentController.php` ‚Äî –Ω–æ–≤—ã–π –º–µ—Ç–æ–¥ `vote`.

–ú–∞—Ä—à—Ä—É—Ç: `POST /comments/{comment}/vote` ‚Üí `CommentController@vote`, name: `comments.vote`

–õ–æ–≥–∏–∫–∞:
1. –í–∞–ª–∏–¥–∞—Ü–∏—è: `vote` ‚Äî required, in: `1, -1`
2. –ü–æ–ª—É—á–∏—Ç—å IP –∏–∑ `$request->ip()`
3. –ù–∞–π—Ç–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –≥–æ–ª–æ—Å: `CommentVote::where(comment_id, ip_address)`
4. –ï—Å–ª–∏ –≥–æ–ª–æ—Å —Ç–∞–∫–æ–π –∂–µ ‚Äî —É–¥–∞–ª–∏—Ç—å (—Å–Ω—è—Ç—å –≥–æ–ª–æ—Å)
5. –ï—Å–ª–∏ –≥–æ–ª–æ—Å –¥—Ä—É–≥–æ–π ‚Äî –æ–±–Ω–æ–≤–∏—Ç—å
6. –ï—Å–ª–∏ –≥–æ–ª–æ—Å–∞ –Ω–µ—Ç ‚Äî —Å–æ–∑–¥–∞—Ç—å
7. –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å `likes_count` –∏ `dislikes_count` –≤ —Ç–∞–±–ª–∏—Ü–µ `comments`
8. –í–µ—Ä–Ω—É—Ç—å JSON: `{ likes_count, dislikes_count, user_vote }` (user_vote: 1, -1 –∏–ª–∏ null)

## 4. –ü–µ—Ä–µ–¥–∞—á–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥

–í `CommentController` ‚Äî –≤ –º–µ—Ç–æ–¥–∞—Ö `show`, `loadMore` –∏ `buildTreeFromCollection`:
- –ö –∫–∞–∂–¥–æ–º—É –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—é –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—è: `likes_count`, `dislikes_count`, `user_vote`
- `user_vote` ‚Äî –≥–æ–ª–æ—Å —Ç–µ–∫—É—â–µ–≥–æ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è (–ø–æ IP), null –µ—Å–ª–∏ –Ω–µ –≥–æ–ª–æ—Å–æ–≤–∞–ª

–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –∑–∞–≥—Ä—É–∂–∞—Ç—å –≥–æ–ª–æ—Å–∞ —Ç–µ–∫—É—â–µ–≥–æ IP –æ–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º –¥–ª—è –≤—Å–µ—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ, –∞ –Ω–µ N+1.

–í –º–µ—Ç–æ–¥–µ `index` ‚Äî –¥–æ–±–∞–≤–∏—Ç—å `likes_count`, `dislikes_count` –∫ –∫–æ—Ä–Ω–µ–≤—ã–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º (user_vote –Ω–µ –Ω—É–∂–µ–Ω –Ω–∞ –≥–ª–∞–≤–Ω–æ–π, —Ç.–∫. —Ç–∞–º –Ω–µ—Ç –∫–Ω–æ–ø–æ–∫ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è).

## 5. –§—Ä–æ–Ω—Ç–µ–Ω–¥ ‚Äî Vue-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç

–§–∞–π–ª: `resources/js/Components/CommentItem.vue`

–î–æ–±–∞–≤–∏—Ç—å –±–ª–æ–∫ —Å –∏–∫–æ–Ω–∫–∞–º–∏ –ª–∞–π–∫/–¥–∏–∑–ª–∞–π–∫ —Ä—è–¥–æ–º —Å –∫–Ω–æ–ø–∫–æ–π ¬´–û—Ç–≤–µ—Ç–∏—Ç—å¬ª:
- –ò–∫–æ–Ω–∫–∞ üëç (SVG thumb up) + —á–∏—Å–ª–æ `likes_count`
- –ò–∫–æ–Ω–∫–∞ üëé (SVG thumb down) + —á–∏—Å–ª–æ `dislikes_count`
- –ü—Ä–∏ –∫–ª–∏–∫–µ ‚Äî POST –Ω–∞ `/comments/{id}/vote` —á–µ—Ä–µ–∑ `fetch` (–Ω–µ Inertia visit, —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É)
- –ê–∫—Ç–∏–≤–Ω—ã–π –≥–æ–ª–æ—Å –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ—Ç—Å—è —Ü–≤–µ—Ç–æ–º (–∑–µ–ª—ë–Ω—ã–π –¥–ª—è –ª–∞–π–∫–∞, –∫—Ä–∞—Å–Ω—ã–π –¥–ª—è –¥–∏–∑–ª–∞–π–∫–∞)
- –ü–æ—Å–ª–µ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞ ‚Äî –æ–±–Ω–æ–≤–∏—Ç—å —Å—á—ë—Ç—á–∏–∫–∏ –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–¥—Å–≤–µ—Ç–∫–∏ –ª–æ–∫–∞–ª—å–Ω–æ

## 6. –§–∞–π–ª—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è

| –§–∞–π–ª | –î–µ–π—Å—Ç–≤–∏–µ |
|------|----------|
| `database/migrations/xxxx_create_comment_votes_table.php` | –°–æ–∑–¥–∞—Ç—å |
| `database/migrations/xxxx_add_vote_counts_to_comments.php` | –°–æ–∑–¥–∞—Ç—å |
| `app/Models/CommentVote.php` | –°–æ–∑–¥–∞—Ç—å |
| `app/Models/Comment.php` | –î–æ–±–∞–≤–∏—Ç—å —Å–≤—è–∑—å hasMany |
| `app/Http/Controllers/CommentController.php` | –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ vote, –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –≥–æ–ª–æ—Å–æ–≤ |
| `routes/web.php` | –î–æ–±–∞–≤–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç POST vote |
| `resources/js/Components/CommentItem.vue` | –î–æ–±–∞–≤–∏—Ç—å UI –ª–∞–π–∫–æ–≤/–¥–∏–∑–ª–∞–π–∫–æ–≤ |

## 7. –ü—Ä–æ–≤–µ—Ä–∫–∞

1. `docker compose exec php php artisan migrate` ‚Äî –º–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–æ—Ö–æ–¥—è—Ç
2. –ù–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è –≤–∏–¥–Ω—ã –∏–∫–æ–Ω–∫–∏ –ª–∞–π–∫/–¥–∏–∑–ª–∞–π–∫ —Å –Ω—É–ª–µ–≤—ã–º–∏ —Å—á—ë—Ç—á–∏–∫–∞–º–∏
3. –ö–ª–∏–∫ –ø–æ –ª–∞–π–∫—É ‚Äî —Å—á—ë—Ç—á–∏–∫ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è, –∏–∫–æ–Ω–∫–∞ –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ—Ç—Å—è
4. –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∫–ª–∏–∫ ‚Äî –≥–æ–ª–æ—Å —Å–Ω–∏–º–∞–µ—Ç—Å—è, —Å—á—ë—Ç—á–∏–∫ —É–º–µ–Ω—å—à–∞–µ—Ç—Å—è
5. –ö–ª–∏–∫ –ø–æ –¥–∏–∑–ª–∞–π–∫—É –ø—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ–º –ª–∞–π–∫–µ ‚Äî –ª–∞–π–∫ —Å–Ω–∏–º–∞–µ—Ç—Å—è, –¥–∏–∑–ª–∞–π–∫ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è
6. `composer test` ‚Äî —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç
